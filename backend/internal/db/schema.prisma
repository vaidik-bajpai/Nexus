datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}
 
generator db {
    provider = "go run github.com/steebchen/prisma-client-go"
}
 
model User {
    id            String    @id @default(uuid())
    firstName     String?
    lastName      String?
    username      String?    
    email         String    @unique
    password      String?
    emailVerified DateTime?
    avatar        String?
    accessToken   String?
    refreshToken  String?
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt
    
    token             Token[]
    accounts          Account[]
    workspaces        Workspace[]
    workspaceMember   WorkspaceMember[]
    createdProjects   Project[]
    createdTasks      Task[]      @relation("TaskCreator")
    assignedTasks     Task[]      @relation("TaskAssignee")
    
    @@index([email])
    @@map("users")
}

model Token {
    uID   String
    token String   @unique
    ttl   DateTime
    scope String
    user  User     @relation(fields: [uID], references: [id], onDelete: Cascade)

    @@unique([uID, scope])
    @@index([uID])
}

model Account {
    id                String   @id @default(uuid())
    userId            String
    type              String   // "oauth" or "credentials"
    provider          String   // "google", "github", "credentials", etc.
    providerAccountId String   // Provider's unique ID for this account
    
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    @@unique([provider, providerAccountId])
    @@index([userId])
    @@map("accounts")
}

model Workspace {
    id String @id @default(uuid())
    name String
    description String
    userId String
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now())
    user  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    workspaceMember   WorkspaceMember[]
    projects           Project[]
    
    @@unique([name, userId])
}

model WorkspaceMember {
    id          String    @id @default(uuid())
    workspaceId String
    userId      String
    role        String    // admin, manager, member
    invitedAt   DateTime  @default(now())
    joinedAt    DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([workspaceId, userId])
    @@index([workspaceId])
    @@index([userId])
    @@map("workspace_members")
}

model Project {
    id          String   @id @default(uuid())
    workspaceId String
    name        String   @db.VarChar(255)
    description String?  @db.Text
    status      String   @default("active") // active, archived, completed
    color       String?  @db.VarChar(7) // hex color code
    createdBy   String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
    creator   User      @relation(fields: [createdBy], references: [id], onDelete: Restrict)
    tasks     Task[]

    @@index([workspaceId])
    @@index([createdBy])
    @@index([status])
    @@map("projects")
}

model Task {
    id          String    @id @default(uuid())
    projectId   String
    title       String    @db.VarChar(255)
    description String?   @db.Text
    status      String    @default("todo") // todo, in_progress, done, etc.
    priority    String    @default("medium") // low, medium, high, urgent
    dueDate     DateTime?
    assignedTo  String?
    createdBy   String
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
    assignee   User?     @relation("TaskAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
    creator    User      @relation("TaskCreator", fields: [createdBy], references: [id], onDelete: Restrict)
    dependencies TaskDependency[] @relation("TaskDependencies")
    dependents   TaskDependency[] @relation("TaskDependents")

    @@index([projectId])
    @@index([assignedTo])
    @@index([createdBy])
    @@index([status])
    @@index([priority])
    @@index([dueDate])
    @@map("tasks")
}

model TaskDependency {
    id          String @id @default(uuid())
    taskId      String
    dependsOnId String

    task      Task @relation("TaskDependencies", fields: [taskId], references: [id], onDelete: Cascade)
    dependsOn Task @relation("TaskDependents", fields: [dependsOnId], references: [id], onDelete: Cascade)

    @@unique([taskId, dependsOnId])
    @@index([taskId])
    @@index([dependsOnId])
    @@map("task_dependencies")
}